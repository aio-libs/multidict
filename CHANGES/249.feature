Replace Cython optimization with pure C